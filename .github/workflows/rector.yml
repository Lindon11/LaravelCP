name: Rector (dry-run)

on:
  pull_request:
    paths:
      - '**.php'
      - 'class/**'
      - 'modules/**'
      - 'rector.php'

jobs:
  rector:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, intl

      - name: Get Composer cache
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --no-progress --no-interaction

      - name: Ensure Rector vendor config exists
        run: |
          # Some Rector releases/packages expect a bundled config file under vendor/rector/rector/config/config.php
          # Create a harmless placeholder if it is missing so the CLI can start and produce diagnostics.
          if [ ! -f vendor/rector/rector/config/config.php ]; then
            mkdir -p vendor/rector/rector/config
            # minimal placeholder to satisfy existence checks
            echo "<?php // placeholder for rector config" > vendor/rector/rector/config/config.php
          fi

      - name: Rector dry-run
        run: vendor/bin/rector process --dry-run --clear-cache
